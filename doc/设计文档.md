# 设计文档

> 白润声  王皓雯

## 关键功能

### 页面跳转

#### 分工：白润声

### 笔记内容搜索

#### 分工：白润声

### 笔记详情页面的呈现

为了让笔记可以实时呈现文字、图像与音频，并且用户可以随时进行编辑、添加、删除等功能的交互，我们选择使用```RecyclerView```来显示笔记的内容，其中每一类内容对应不同类型的```NoteItem```。```NoteItem```的属性包括类型```type```与内容```content```。```content```分别用来记录文字的内容、图像的```url```, 和音频文件的```url```。不同类型的```NoteItem```有不同的```ViewHolder```来呈现，分别是自定义类```TextViewHolder```，```ImageViewHolder```，和```AudioViewHolder```。每一类```ViewHolder```中有对应的组件来呈现不同类型的内容。

使用了```RecyclerView```之后，笔记内容的添加与删除就非常方便了，只需对```List<NoteItem>```类对象``` noteList```进行```add```和```remove```操作等。

#### 选择本地相册功能

为了实现选择本地相册功能，我们创建了一个```Intent(Intent.ACTION_PICK, MediaStore.Images.Media.EXTERNAL_CONTENT_URI);```来指定从相册选择图片。一旦用户选择了图片并且返回时，我们获取图片的```uri```后，添加到```noteList```来更新前端。此时前端展示的图片为本地路径下的图片。同时，前端调用```uploadImage```函数将图片传到后端，实现笔记的同步。

在```uploadImage```函数中，我们首先将图片内容转换为字节数组，创建一个 `RequestBody` 对象，将字节数组作为请求体，并指定其内容类型为 `"image/jpeg"`，表示照片的类型为 JPEG。之后再创建一个 `MultipartBody.Builder` 对象，并设置其类型为 `MultipartBody.FORM`，来使用表单形式提交数据，包括用户的```id```，当前笔记的```path```，和```requestBody```。接着调用```api```接口实现图片的上传。

后端获得图片文件后，会更新图片路径为后端的路径。当前端再次加载页面时，前端显示的图片将为后端路径下的图片，而非本地图片。为了避免图片上传时间过长，笔记页面无法正确加载，当前端得到选择的图片后，后端会先添加默认图片到笔记中，等图片上传成功后再将路径进行替换。这样最大程度地考虑到了用户的体验感和交互感。

#### 相机拍摄功能

与添加本地相册的图片相比，实现相机拍摄要更加复杂，因为需要动态地获取权限。首先检查应用是否具有相机权限，如果有则打开相机，如果没有则请求相机权限。申请权限时，系统会显示权限请求对话框，让用户决定是否授予相机权限。获取到权限之后，调用```openCamera```函数来实现具体的拍摄功能。

```openCamera```函数中，通过创建```Intent(MediaStore.*ACTION_IMAGE_CAPTURE*);```来启动相机进行拍摄，并且根据设备的 Android 版本和相机应用的可用性，选择合适的方式创建照片保存的文件路径或内容 URI。后续操作与选择本地相册类似，包括前端的更新、与上传，后端的创建与替换。

#### 添加录音得到的音频文件

录音功能包括，用户分别点击开始录音与结束录音按钮进行录音，前端播放音频文件、上传文件到后端进行同步。

与相机拍摄类似，录音也需要动态获取权限。具体的录音过程借助了```MediaRecorder```类来实现。而音频文件的上传与图片的上传类似，通过```RequestBody```和```MultipartBody```类提交表单数据。

#### 图片与音频的删除

为了让用户可以便捷删除图片与音频文件，我们设计了长按删除的功能。进行删除时，前端调用```deleteItem```接口更新后端的笔记内容数据，同时前端删除```noteList```中图片和音频对应的```NoteItem```，并且将前后的文字部分进行合并，方便用户的编辑。

#### 分工：王皓雯



